<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibecodingchile | VibePredict Notebook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0d0d0d; color: #e0e0e0; }
        .ccu-green { color: #00e676; }
        .ccu-bg-green { background-color: #00e676; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="p-5 font-sans">
    <header class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold italic">vibecodingchile <span class="ccu-green">VibePredict</span></h1>
        <input type="password" id="apiKey" placeholder="Ingresa API Key aquí" class="bg-gray-900 border border-gray-700 rounded px-3 py-1 text-sm outline-none focus:border-green-500">
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass p-6 rounded-2xl md:col-span-3 mb-4">
            <h2 class="text-xl mb-4 font-semibold ccu-green">Predicción de Quiebre de Stock (Demo)</h2>
            <div class="h-[250px] w-full"><canvas id="predictionChart"></canvas></div>
        </div>

        <div class="glass p-6 rounded-2xl">
            <h2 class="text-xl mb-4 font-semibold">1. Contexto Comercial</h2>
            <div class="text-sm p-4 bg-gray-900 rounded border-l-4 border-green-500 text-gray-300">
                <p><b>Archivo cargado:</b> ventas_febrero_2026.csv</p>
                <p class="mt-2"><b>Productos Top:</b> Cerveza Escudo, Pepsi 1.5L, Cristal.</p>
                <p class="mt-2"><b>Alerta:</b> Temperatura proyectada 32°C para el sábado en Santiago.</p>
            </div>
        </div>

        <div class="md:col-span-2 glass p-6 rounded-2xl flex flex-col h-[400px]">
            <h2 class="text-xl mb-4 font-semibold">2. Consultar al Motor VibePredict</h2>
            <div id="chat-box" class="flex-1 overflow-y-auto space-y-4 mb-4 p-2 text-sm">
                <div class="bg-gray-800 p-3 rounded-lg self-start max-w-[80%] text-green-400">
                    <b>VibePredict:</b> Sistema en línea. Analizando historial de Mi Carro CCU. ¿Qué necesitas predecir, Jefe?
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="userInput" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-3 outline-none focus:border-green-500" placeholder="Ej: ¿Qué sugieres que pida la botillería 'El Sol' para este fin de semana?">
                <button onclick="askAI()" class="ccu-bg-green text-black font-bold px-6 rounded-lg hover:brightness-110 transition">Predecir</button>
            </div>
        </div>
    </main>

    <script>
        // 1. Configuración del Gráfico
        const ctx = document.getElementById('predictionChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'],
                datasets: [{
                    label: 'Stock en Local (Proyectado)',
                    data: [80, 75, 60, 40, 15, 5, 0],
                    borderColor: '#ff5252', tension: 0.4
                }, {
                    label: 'Stock Sugerido por VibePredict',
                    data: [80, 75, 60, 90, 120, 110, 85],
                    borderColor: '#00e676', backgroundColor: 'rgba(0, 230, 118, 0.1)', fill: true, tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#333' } }, x: { grid: { color: '#333' } } } }
        });

        // 2. Lógica de conexión a la IA (Con diagnóstico de errores)
        async function askAI() {
            const input = document.getElementById('userInput').value;
            const apiKey = document.getElementById('apiKey').value.trim(); 
            const chatBox = document.getElementById('chat-box');
            
            if (!apiKey) { 
                alert("⚠️ Jefe, falta la API Key. Cópiala y pégala en la esquina superior derecha."); 
                return; 
            }
            if (!input) return;

            chatBox.innerHTML += `<div class="bg-gray-700 p-3 rounded-lg self-end text-right ml-auto max-w-[80%]"><b>Tú:</b> ${input}</div>`;
            document.getElementById('userInput').value = '';
            
            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="text-gray-500 text-xs italic">VibePredict está conectando con los servidores...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            const systemPrompt = "Eres VibePredict, IA de vibecodingchile para CCU. Responde muy corto, técnico y enfocado en stock B2B. Pregunta: " + input;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                
                const data = await response.json();
                document.getElementById(loadingId).remove();
                
                if (!response.ok) {
                    console.error("Error de Google:", data);
                    chatBox.innerHTML += `<div class="bg-red-900 border border-red-500 p-3 rounded-lg self-start max-w-[80%] text-red-200">
                        <b>⚠️ Error del Servidor:</b> ${data.error ? data.error.message : 'Error desconocido'}<br>
                        <small><i>Revisa que tu API Key esté bien copiada y no tenga espacios extra.</i></small>
                    </div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    return;
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                chatBox.innerHTML += `<div class="bg-gray-800 border border-green-500 p-3 rounded-lg self-start max-w-[80%] text-green-300"><b>VibePredict:</b> ${aiResponse}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch (error) {
                console.error("Error de código o red:", error);
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="bg-red-900 border border-red-500 p-3 rounded-lg self-start max-w-[80%] text-red-200">
                    <b>⚠️ Error de Conexión:</b> No se pudo llegar al servidor. ¿Estás conectado a internet?
                </div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    </script>
</body>
</html>
